@using TODO.PersistObject.models
@model List<TODO_Tasks>
<link rel="stylesheet" href="@Url.Content("~/Content/css/index.css")" />
<script type="text/javascript">
    $(document).ready(function () {

        $('#content-table').dataTable({
            "aaSorting": [[0, "desc"]],
            "bJQueryUI": true,
            "sPaginationType": "full_numbers",
            "sDom": '<""l>t<"F"fp>',
            "bFilter": true,
            "oLanguage": {
                "sLengthMenu": "每页显示 _MENU_ 条记录",
                "sZeroRecords": "对不起，查询不到任何相关数据",
                "sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
                "sInfoEmtpy": "找不到相关数据",
                "sInfoFiltered": "数据表中共为 _MAX_ 条记录)",
                "sProcessing": "正在加载中...",
                "sSearch": "搜索",
                "sUrl": "",
                "oPaginate": {
                    "sFirst": "第一页",
                    "sPrevious": " 上一页 ",
                    "sNext": " 下一页 ",
                    "sLast": " 最后一页 "
                }
            },
            "fnDrawCallback": function () {
                var nTrs = $('#content-table .gradeA');
                var iColspan = nTrs[0].getElementsByTagName('td').length;
                var groupVal = "";
                var sGroup = "";
                var groupClass = "group_0";
                for (var i = 0; i < nTrs.length; i++) {
                    if (iColspan > 1) {
                        var nGroup = document.createElement('tr');
                        var nCell = document.createElement('td');
                        nCell.colSpan = iColspan;
                        nCell.align = "left";
                        nCell.id = "group_" + nTrs.eq(i).find("td").eq(8).attr("id");
                        nCell.className = "group";
                        nCell.innerHTML = nTrs.eq(i).find("td").eq(8).html();
                        nGroup.appendChild(nCell);
                        $(nGroup).insertAfter(nTrs[i]);
                        groupVal = sGroup;
                        groupClass = "group_" + i;
                    }
                    nTrs.eq(i).addClass(groupClass);
                }
            },
            "aoColumns": [
			            null, null, null, null, null, null,
			            { "asSorting": [] }, { "asSorting": [] }, { "asSorting": [] }
		            ]
        });

        $('select').select2();
        $("#delay").validate({
            rules: {
                DelayDate: {
                    required: true,
                    date: true
                },
            },
            errorClass: "help-inline",
            errorElement: "span",
            highlight: function (element, errorClass, validClass) {
                $(element).parents('.control-group').addClass('error');
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).parents('.control-group').removeClass('error');
            }
        });
        $('.datepicker').datepicker({dateFormat:"yy/mm/dd" });
    });
    </script>
<div id="content-header">
				<h1>任务管理</h1>
			</div>
			<div id="breadcrumb">
                <input type='button' value="新增任务" style="margin-right: 20px;" onclick="location.href='@Url.Action("Create", "Task")'" class='btn btn-primary subcat_hide' />
			</div>
			<div class="container-fluid">
				<div class="row-fluid">
					<div class="span12">
						<div class="widget-box">
							<div class="widget-title">
								<h5></h5>
							</div>
							<div class="widget-content nopadding">
								<table id="content-table" class="table table-bordered data-table">
                                <thead>
                                    <tr>
                                        <th width="60px">
                                            优先级
                                        </th>
                                        <th width="150px">
                                            任务名
                                        </th>
                                        <th width="100px">
                                            任务类型
                                        </th>
                                        <th>
                                            完成进度
                                        </th>
                                        <th width="100px">
                                            要求完成时间
                                        </th>
                                        <th width="100px">
                                            任务状态
                                        </th>
                                        <th width="100px">
                                            快捷操作
                                        </th>
                                        <th width="110px">
                                            
                                        </th>
                                        <th class="hide_css">&nbsp;</th>
                                    </tr>
                                </thead>
                                <tbody>
                                @foreach (var obj in Model)
                                {
                                    <tr class="gradeA">
                                        <td>
                                            @obj.Priority
                                        </td>
                                        <td>
                                            @obj.TaskName <span onclick="toggleSubcat(@obj.ID)" >[展开]</span>
                                        </td>
                                        <td>
                                            @obj.TaskType
                                        </td>
                                        <td>
                                            %50
                                        </td>
                                        <td>
                                            @obj.TaskDeadLine.Value.ToShortDateString()
                                        </td>
                                        <td class="center">
                                           @if (obj.TaskStatus == 0)
                                           {@Html.Raw("未分配")}
                                           else
                                           {@Html.Raw("已分配")}
                                        </td>
                                        <td class="center">
                                            <div class="btn-group">
                                                <button onclick="create_children(@obj.ID, 1)" class="btn btn-small">生成子任务</button>
                                                <button data-toggle="dropdown" class="btn btn-small dropdown-toggle"><span class="caret"></span></button>
                                                <ul class="dropdown-menu">
                                                    <li><a href="#" onclick="create_children(@obj.ID, 2)">生成2个子任务</a></li>
                                                    <li><a href="#" onclick="create_children(@obj.ID, 3)">生成3个子任务</a></li>
                                                    <li><a href="#" onclick="create_children(@obj.ID, 4)">生成4个子任务</a></li>
                                                    <li><a href="#" onclick="create_children(@obj.ID, 5)">生成5个子任务</a></li>
                                                </ul>
									        </div>
                                        </td>
                                        <td class="center">
                                           <a href="#" onclick="addNewM(@obj.ID)">延期</a>|
                                           <a href="@Url.Action("Edit", "Task", new { id = @obj.ID })">修改 </a>|
                                           <a onclick="return confirm('确认要删除吗,子任务会一同删除！')" href="@Url.Action("Delete", "Task", new { id = @obj.ID })">删除</a>
                                        </td>
                                        <td id="@obj.ID" class="hide_css">
                                            <table class="subTable" border="0" cellpadding="0" cellspacing="0">
                                            @foreach (var child in obj.Child_Tasks.ToList())
                                            {
                                                <tr>
                                                    <td>@child.TaskName</td>
                                                    <td style="width: 17%">进度</td>
                                                    <td>
                                                        <a href="#" onclick="addNewM(@child.ID)">延期</a>|
                                                       <a href="@Url.Action("Edit", "Task", new { id = @child.ID })">修改 </a>|
                                                       <a onclick="return confirm('确认要删除吗！')" href="@Url.Action("Delete", "Task", new { id = @child.ID })">删除</a>
                                                    </td>
                                                </tr>
                                            }
                                            </table>
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
							</div>
                            <div title="任务延期" id="DelayModal" style="margin: 8px;display: none;">
                            @using (Html.BeginForm("Delay", "Task", FormMethod.Post, new { id = "delay" }))
                            {
								<div class="modal-body">
									<table cellpadding="0" cellspacing="0" class="addtable">
                                        <tr>
                                            <td width="90">任务名：</td>
                                            <td>(请勿重复)<input name="DelayTask" id="DelayTask" type="text" /></td>
                                        </tr>
            
                                        <tr>
                                            <td>延期时间：</td>
                                            <td><input name="DelayDate" id="DelayDate" type="text"  class="datepicker" /></td>
                                        </tr>
								        <tr>
                                            <td colspan="2" style="text-align: left;padding-left:80px;">
                                                <input type='submit' class='btn btn-primary' value="保存" />
                                                <input type="button" value="取消" class='btn btn-primary' style="margin-left: 40px;" onclick="closeDlg('DelayModal')"/>
                                            </td>
                                        </tr>
                                    </table>
								</div>
                            }
							</div>
						</div>
					</div>
				</div>
			</div>
            
<script type="text/javascript" src="@Url.Content("~/Content/js/jquery.validate.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Content/js/jquery-ui.min.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Content/js/common.js")"></script>
<script type="text/javascript">
    function addNewM(id) {
        document.getElementById("delay").reset();
        var modeldialog = $("#DelayModal");
        modeldialog.dialog({
            modal: true,
            autoOpen: false,
            resizable: false,
            width: 495
        });
        $("#DelayTask").val(id);
        modeldialog.dialog('open');
    }
    function saveNewM() {
        closeDlg('DelayModal');
        return true;
    }
    function toggleSubcat(id) {
		$("#group_" + id).toggle();
    }
    function create_children(tid, count) {
        var temp = document.createElement("form");
        temp.action = "@Url.Action("CreateChild", "Task")";
        temp.method = "post";
        temp.style.display = "none";
        
        var opt = document.createElement("textarea");
        opt.name = "id";
        opt.value = tid;
        temp.appendChild(opt);

        var opt_c = document.createElement("textarea");
        opt_c.name = "child_count";
        opt_c.value = count;
        temp.appendChild(opt_c);
        document.body.appendChild(temp);
        temp.submit();
        return temp;
    }
</script>